# NBAI-API
Описание и примеры использования REST-подобного API Национального бюро автомобильных историй. Формат данных - JSON
## Ключ API

Ключ API выдается при предварителному согласованию с администрацией ресурса и используется для запроса информации по автомобилю

**ВНИМАНИЕ!** Используйте ключ только в защищеных частях приложения (на сервере).

## Адреса API
Для доступа к API используется http протокол. 

Адрес для запросов:
*http://api.nbai.ru*

## Запрос информации
NBAI-API предоставляет возможность запрашивать информацию с разных источников по отдельности. 
Некоторые источники могут передавать информацию только по VIN номеру автомобиля, другие могут передавать информацию как по VIN/номеру кузова так и по гос. номеру автомобиля. Подробнее в разделе "Описание источников"

Существует 2 вида информации:

1. Бесплатная
2. Платная

### Формат запроса

Запрос бесплатной информации по гос. номеру автомобиля:
*http://api.nbai.ru/v1/get_by_num/:API_KEY/:NUM/:DATA/free*

Где:
* API_KEY - ключ доступа к API
* NUM - гос. номер автомобиля
* DATA - название источника для получения данных (подробнее в разделе "Описание источников")
* free - пометка того, что мы получаем только бесплатную информацию

Запрос бесплатной информации по VIN/номеру кузова автомобиля. Использование VIN или номера кузова будет определено автоматически
*http://api.nbai.ru/v1/get_by_vin/:API_KEY/:VIN/:DATA/free*

Где:
* API_KEY - ключ доступа к API
* VIN - VIN номер/номер кузова
* DATA - название источника для получения данных (подробнее в разделе "Описание источников")
* free - пометка того, что мы получаем только бесплатную информацию


### Рабочий пример запроса
```javascript
Например нам нужно запросить информацию из базы ЕАИСТО по гос. номеру а999му199

GET http://api.nbai.ru/v1/get_by_num/my_api_key/а999му199/eaisto/free


Статусы:

* 200 - запрос прошел успешно, тело ответа содержит запрашиваемые данные
* 503 - ошибка сервера, возможно сервер перегружен
* 400 - ошибка валидации параметров запроса
* 404 - ошибка формаирования запроса. Проверьте правильность запроса
* остальные - ошибка сервера, возможно сервер перегружен

Ответ сервера:

{ "eaisto":
	[
		{
			"body":"WAUZZZ4G5CN021391", 	//Номер кузова
			"car":"АУДИ А6",				//название авто
			"date":"2014-09-23",			//дата выдачи ТО
			"dateto":"2016-09-23",			//Действие до
			"list":"201409232009069495800",	//Номер карты в ЕАИСТО
			"num":"А999МУ199",				//Номер авто
			"vin":"WAUZZZ4G5CN021391"		//VIN номер
		}
		
	],
   "data_price":0							//Стоимость полной версии данных в рублях
}


```

### Пример платного запроса
```javascript
Например нам нужно запросить информацию из базы автообъявлений по номеру А999МУ199. Стоимость данных - 700р

GET http://api.nbai.ru/v1/get_by_num/my_api_key/а999му199/card/buy


Статусы:

* 200 - запрос прошел успешно, тело ответа содержит запрашиваемые данные
* 503 - ошибка сервера, возможно сервер перегружен
* 400 - ошибка валидации параметров запроса
* 404 - ошибка формаирования запроса. Проверьте правильность запроса
* 403 - на балансе недостаточно средств
* остальные - ошибка сервера, возможно сервер перегружен

Ответ сервера:

{ "card":
	[
		{
			"bid":"123456", 	//id объявления
			"id":"123456",	//не используется
			"href":"http://google.ru", //ссылка на объявление
			"imgs": //массив ссылок на фотографии из объявления
				[
				"http://avito.ru/img", 
				"http://drom.ru/img",
				]
		}
		
	],
   "data_price":700, //Стоимость этих данных
   "balance":1920 //баланс после покупки
}


```

## Другие методы
### Запрос баланса

```javascript
GET http://api.nbai.ru/v1/get_balance/API-KEY


Статусы:

* 200 - запрос прошел успешно, тело ответа содержит запрашиваемые данные
* 503 - ошибка сервера, возможно сервер перегружен
* 400 - ошибка валидации параметров запроса
* 404 - ошибка формирования запроса. Проверьте правильность запроса
* остальные - ошибка сервера, возможно сервер перегружен

Ответ сервера:

{ 
	"balance":250	//Баланс в рублях
}


```

### Пополнение баланса

```javascript
Метод позволяет получить форму пополнения баланса ключа НБАИ. Пополнение баланса можно вызывать непосредственно перед покупкой отчета (например когда баланс пополняет ваш клиент), или заранее.

GET http://api.nbai.ru//v1/get_pay_form/API-KEY/:amount/:success_url/:fail_url/:return_url

:amount - сумма на которую нужно пополнить баланс
:success_url - urlencode ссылка на которую будет возвращен пользователь после оплаты (для PHP функция urlencode для JavaScript - encodeURIComponent)
:fail_url - ссылка на которую будет возвращен пользователь в случае неудачной оплаты
:return_url - ссылка на которую будет возвращен пользователь если захочет вернутся обратно в магазин

Статусы:

* 200 - запрос прошел успешно, тело ответа содержит запрашиваемые данные
* 503 - ошибка сервера, возможно сервер перегружен
* 400 - ошибка валидации параметров запроса
* 404 - ошибка формирования запроса. Проверьте правильность запроса
* остальные - ошибка сервера, возможно сервер перегружен

Ответ сервера:

{ 
	"balance":250,	//Текущий баланс в рублях
	"transanction_id":"d05f9b334d132807c62012133bdd0984", //id транзанкции в платежной системе
	//HTML код формы оплаты. Html код может менятся, поэтому рекомендуется использовать его для пополнения счета. Автоматическая отправка этой формы возможна с помощью jQuery
	"pay_form":"\n\t\t<p>Сумма к оплате: <b>900.00</b></p>\n\t\t<form method =\"post\" action =\"https://www.moneta.ru/assistant.htm\" id=\"payform\"> \n\t\t\t<input type=\"hidden\" name=\"MNT_ID\" value=\"74377777\">  \n\t\t\t<input type=\"hidden\" name=\"MNT_TRANSACTION_ID\" value=\"321\"> \n\t\t\t<input type=\"hidden\" name=\"MNT_CURRENCY_CODE\" value=\"RUB\"> \n\t\t\t<input type=\"hidden\" name=\"MNT_AMOUNT\" value=\"900.00\"> \n\t\t\t<input type=\"hidden\" name=\"MNT_SIGNATURE\" value=\"d10e3a5ecd84a27c18f4d6d31248b1ec\"> \n\t\t\t<input type=\"hidden\" name=\"MNT_TEST_MODE\" value=\"1\">\n\t\t\t<input type=\"hidden\" name=\"MNT_CUSTOM1\" value=\"d05f9b334d132807c62012133bdd0984\">\n\t\t\t<input type=\"hidden\" name=\"MNT_SUCCESS_URL\" value=\"http://google.ru\">\n\t\t\t<input type=\"hidden\" name=\"MNT_FAIL_URL\" value=\"3\">\n\t\t\t<input type=\"hidden\" name=\"MNT_RETURN_URL\" value=\"4\">\n\t\t\t\n\t\t\t<input type=\"submit\" value=\"Оплатить заказ\"> \n\t\t</form>\n\n"
}


```
